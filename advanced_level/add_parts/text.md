## üîê Step 4: Serve NGINX Over HTTPS with minica

Your rock is now rootless and serving static content via NGINX, great progress! In this step, you‚Äôll make your rock serve **HTTPS traffic** using self-signed certificates generated by [minica](https://github.com/jsha/minica).

---

## üß™ A Note About minica

[minica](https://github.com/jsha/minica) is a simple tool for generating a root certificate authority (CA) and signing TLS certificates for development purposes. It‚Äôs perfect for local testing and demos, **but it should NOT be used in production**.

---

## üìù Instructions

You‚Äôre going to:

1. **Modify your nginx.conf** to expose the index.html via HTTPs. See the next section.
2. **Add a new part to build `minica` from source** using the [Go plugin](https://documentation.ubuntu.com/rockcraft/en/latest/common/craft-parts/reference/plugins/go_plugin/).
3. **Create another part** that runs `minica` to generate a TLS certificate for a domain called `hello-rock`.
    * Override the build step to create a new directory at `/var/www/letsencrypt` and generate `minica` certificates inside.
    * Override the prime step to set the ownership of `/var/www/letsencrypt`

> Note that when overriding the build step all files will be under `CRAFT_PART_INSTALL` the same way `CRAFT_PRIME` works when overriding the prime step.

---

### üõ†Ô∏è Updated Nginx.conf

This is the updated `nginx.conf` file:

```nginx
server {
    listen 80;
    server_name localhost;

    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;

    location / {
        root /var/www/html;  # Directory containing static files
        index index.html index.htm;
        try_files $uri $uri/ =404;  # Serve 404 if file not found
    }

    ssl_certificate /var/www/letsencrypt/hello-rock/cert.pem;
    ssl_certificate_key /var/www/letsencrypt/hello-rock/key.pem;
}
```

---

## ‚úÖ Testing

Once you‚Äôve updated your `rockcraft.yaml`, build and test with:

```bash
rockcraft pack
skopeo-copy <your-rock-name>
docker run --rm -d -p 8080:80 -p 8443:443 --name hello-nginx "<your-rock-name>:latest"
```

Once the container is running (you can check with `docker ps`) you can use `curl`:

```bash
curl http://localhost:8080
```

note that you will be redirected when using `HTTP`, since we configured
that previously for Nginx:

```
    <html>
    <head><title>301 Moved Permanently</title></head>
    <body>
    <center><h1>301 Moved Permanently</h1></center>
    <hr><center>nginx/1.24.0 (Ubuntu)</center>
    </body>
    </html>
```

If using `curl`, you can specify the `-L` option to follow the
redirection:

```
curl -Lk http://localhost:8080
```

> Since the certificates are self-signed and hence, invalid, you will
get a warning page in your browser. If using curl, it will throw an
error unless you pass ``-k`` option, which allows access to insecure
sites.

The output should now be the contents of `index.html`:

```
<!doctype html>
<html>
  <head>
    <title>Hello, World!</title>
  </head>
  <body>
    <p>Hello World! From a Rock!</p>
  </body>
</html>
```

Remember to stop your container:

```bash
docker stop hello-nginx
```
